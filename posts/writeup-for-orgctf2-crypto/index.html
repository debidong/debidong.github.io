<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Writeup for ORGCTF2: Crypto.my_own_cryptography - debidong's site</title><meta name=Description content="A Crypto challenge as a starting point to explore the security vulnerabilities of stream ciphers."><meta property="og:title" content="Writeup for ORGCTF2: Crypto.my_own_cryptography"><meta property="og:description" content="A Crypto challenge as a starting point to explore the security vulnerabilities of stream ciphers."><meta property="og:type" content="article"><meta property="og:url" content="http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/"><meta property="og:image" content="http://www.debidong.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-03T15:00:00+08:00"><meta property="article:modified_time" content="2023-11-03T15:00:00+08:00"><meta property="og:site_name" content="debidong's site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.debidong.github.io/logo.png"><meta name=twitter:title content="Writeup for ORGCTF2: Crypto.my_own_cryptography"><meta name=twitter:description content="A Crypto challenge as a starting point to explore the security vulnerabilities of stream ciphers."><meta name=application-name content="debidong's site"><meta name=apple-mobile-web-app-title content="debidong's site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/><link rel=prev href=http://www.debidong.github.io/posts/everything-about-https/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Writeup for ORGCTF2: Crypto.my_own_cryptography","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.debidong.github.io\/posts\/writeup-for-orgctf2-crypto\/"},"genre":"posts","keywords":"cybersecurity, CTF, Crypto","wordcount":1749,"url":"http:\/\/www.debidong.github.io\/posts\/writeup-for-orgctf2-crypto\/","datePublished":"2023-11-03T15:00:00+08:00","dateModified":"2023-11-03T15:00:00+08:00","license":"debidong","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"debidong"},"description":"A Crypto challenge as a starting point to explore the security vulnerabilities of stream ciphers."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="debidong's site">debidong's site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="debidong's site">debidong's site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writeup for ORGCTF2: Crypto.my_own_cryptography</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=www.debidong.github.io title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>debidong</a></span>&nbsp;<span class=post-category>included in <a href=/categories/ctf/><i class="far fa-folder fa-fw" aria-hidden=true></i>CTF</a>&nbsp;<a href=/categories/crypto/><i class="far fa-folder fa-fw" aria-hidden=true></i>Crypto</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-11-03>2023-11-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1749 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-challenge>1 Challenge</a></li><li><a href=#2-solution>2 Solution</a><ul><li><a href=#21-analyzing-the-encrypt-function>2.1 Analyzing the <code>encrypt</code> Function</a></li><li><a href=#22-about-xor>2.2 About XOR</a></li><li><a href=#23-ascii-codes-and-xor>2.3 ASCII Codes and XOR</a></li><li><a href=#24-final-solution-approach>2.4 Final Solution Approach</a></li><li><a href=#25-using-hamming-distance-to-estimate-key-length>2.5 Using Hamming Distance to Estimate Key Length</a></li></ul></li><li><a href=#3-conclusion>3 Conclusion</a></li></ul></nav></div></div><div class=content id=content><p>This is a cryptography challenge from ORGCTF2 at Harbin Engineering University. We will use this challenge as a starting point to explore the security vulnerabilities of stream ciphers.</p><h2 id=1-challenge>1 Challenge</h2><blockquote><p>After completing a cryptography course, Yang decided to design a secure and computationally efficient encryption algorithm. He boasted that this algorithm was invulnerable and openly shared his source code and encryption examples with the public. Now, there is a copy of this example here, and we hope you can show him the power of a skilled hacker.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>debidong</span> <span class=kn>import</span> <span class=n>story</span><span class=p>,</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>+=</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=o>*</span> <span class=s2>&#34; &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span> <span class=o>//</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>ciphertext</span> <span class=o>+=</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>plaintext</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>+</span> <span class=n>j</span><span class=p>])</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=n>j</span><span class=p>]))[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>encrypt</span><span class=p>(</span><span class=n>story</span><span class=p>,</span> <span class=n>flag</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 201c040654130b1f5f45005311360755454e361a48047f232c3b2430294c5d0c130b0f11025b387430222723734a44010b2d114809363e20316335665615060602431c070f505f040c16017f26591d1a33114832372131306d740a48091b1e0243230e120454451612167f1c551b177f0705042d3c65342d30664d121917034337323d5e112d04530a391e55074e2f151a11362b2c25222023455d061c472020205b135e08111611361e5906002c54090b3b6824362b3d2357180b520a021a1f5b154906041f093a0444491c3a071d092b3b6b750c3a2301190e0b4b43000e1e507920343031194a5b0000381007087f3f2426633d28571c0b170343161f5b1850060a16172c44103d063a5400043c232027307422440e1b00081a11025b04590041180c310d5406037807480b3a3c323a313f6652041c06020e540715141116151c093a4a44010b7f1f010b382c2a3864276656180e1e130b5a46371945110d16450802591d0b7f100d06362c2031632029010e1b13090754130b50500b0553013a0c55081a7f0000007f202436283134525d1b1d471015101e50450d04530e3604570d01325a4829363c313926741149141b17470111011a1e110d0800453e0e460c002b011a0071680d3063322f530e1b52010c01081f50450d045306331f551a4e33110e117f2a3c75373c2301150e110c0606155750500b055311370f5e491a2d150b0e3a2c65312c232801090717470b15051015431646530d360e55061b2b5409063c2737312a3a2101090052130b1146181c4400125d451604101d063a5400043c23202730736649140b170816004a5b3c5811151f007f3d58001a3a5400043b682475253d23531e0a520502001217151112080070d7f1e580c4e37150b0e3a3a367b63152055181d5206431c0709141107000711330f1c492236001c093a68123d2a2023011b061c060f181f5b1454030412113a0e101d063a5400043c2320273074274f194f01061511025b04590041180c310d54060371543c0d3a6835302c242a445d001447171c035b1b580b06170a324a470c1c3a541e002d316532313532441b1a1e47171b46371945110d16450802591d0b7f1506017f2b24392f31220115061f4702540e1e025e4b413f0c2b1e5c0c4e081c01113a6f367530202953044f01171111071f50450d131c1038025f1c1a7f0000007f232c3b2430294c514f1b0910040f09195f024116133a184906003a5a4820292d372c2c3a23011500020210541213114545151b00264a5308007f15041630682730203b2b445d0e520f0606095b1c580e045329361e44050b7f23000c2b2d65342d30664714081a1343120909505b1012070c3c0f1e492731541c0d3a68203b277429475d1b1a0243071214024849413f0c2b1e5c0c4e081c01113a68273020352b445d1b1a024313131a02550c001d45300c101d063a5420200a0b1113633f2f4f1a0b1d0a4d542e1e50520a0f070c311f550d4e2b1b48162b3d212c633c2753194f130907540f1600430a171645370343491d341d04092c682c3b633b3445181d52130c54041e0445001353152d05440c0d2b541c0d3a682e3c2d33224e104152474354465b5011454153457f4a10494e7f5448457f686575637466015d</span>
</span></span></code></pre></div><h2 id=2-solution>2 Solution</h2><h3 id=21-analyzing-the-encrypt-function>2.1 Analyzing the <code>encrypt</code> Function</h3><p>First, let&rsquo;s focus on the <code>encrypt</code> function. By manually renaming variable names to make the code clearer, we can deduce the approximate code of the original function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>+=</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=o>*</span> <span class=s2>&#34; &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span> <span class=o>//</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>ciphertext</span> <span class=o>+=</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>plaintext</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>+</span> <span class=n>j</span><span class=p>])</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=n>j</span><span class=p>]))[</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ciphertext</span>
</span></span></code></pre></div><p>In this function, the following steps are performed:</p><ol><li>The plaintext is padded to ensure that its length is a multiple of the key length. It adds spaces to the end of the plaintext to achieve this.</li><li>The plaintext is divided into segments with a length equal to the key&rsquo;s length. Then, for each segment, each character is XORed with the corresponding character from the key.</li><li>The XOR result is converted to a hexadecimal string with leading zeros if necessary and added to the ciphertext.</li></ol><p>It&rsquo;s clear that this function is using a simple XOR-based encryption mechanism. However, there is a significant security flaw in this encryption approach (as discussed in the next section).</p><h3 id=22-about-xor>2.2 About XOR</h3><p>Let&rsquo;s briefly recall the truth table for the XOR operation:</p><table><thead><tr><th></th><th>0</th><th>1</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>0</td></tr></tbody></table><p>XOR returns true (1) when the two bits being compared are different; otherwise, it returns false (0). One important property of XOR is that <strong>XORing a number with itself results in 0</strong>, and XOR also obeys the commutative law. Therefore, the XOR operation has the following property:</p><p><strong>The result of XORing two numbers bitwise is the same as XORing each number with a common number and then XORing the results together</strong>:</p><p>That is:</p><p>$$
a \oplus b = (a \oplus c) \oplus (b \oplus c)
$$</p><p>This property is straightforward to prove because the first two properties hold:</p><p>$$
(a \oplus c) \oplus (b \oplus c) = (a \oplus b) \oplus (c \oplus c) = a \oplus b
$$</p><p>Now, let&rsquo;s consider what information can be revealed by XORing plaintexts.</p><h3 id=23-ascii-codes-and-xor>2.3 ASCII Codes and XOR</h3><p>Do you remember what ASCII codes are? Nowadays, ASCII codes are a subset of UTF and are used to represent English characters and control symbols using 8-bit characters.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/1280px-USASCII_code_chart.png data-srcset="./assets/1280px-USASCII_code_chart.png, ./assets/1280px-USASCII_code_chart.png 1.5x, ./assets/1280px-USASCII_code_chart.png 2x" data-sizes=auto alt=./assets/1280px-USASCII_code_chart.png title=1280px-USASCII_code_chart></p><p>Now, let&rsquo;s focus on the ASCII code for the <strong>space</strong> character, which is <code>0x20</code>. In binary representation, it is <code>00100000</code>. Let&rsquo;s also consider the letter <code>A</code>, whose corresponding ASCII code is <code>01000001</code>. What happens when we XOR <code>A</code> with a space?</p><p>First, let&rsquo;s XOR the lower four bits. Since <strong>0 XOR any number is 0</strong>, the lower four bits of the result will be the same as the lower four bits of <code>A</code>. Then, let&rsquo;s XOR the upper four bits. The space&rsquo;s sixth bit is 1, which means it will make the result&rsquo;s sixth bit opposite to <code>A</code>, while the other bits remain unchanged. The final result is <code>01100001</code>, which corresponds to <code>a</code>.</p><p>With this property, we can determine that when we XOR the ciphertext pairwise, and if the XOR result contains a letter, it implies that the corresponding position in the plaintext should be a character within the range of A-Z or a-z. (Don&rsquo;t forget that ciphertext XOR is equal to plaintext XOR.)</p><h3 id=24-final-solution-approach>2.4 Final Solution Approach</h3><p>After breaking the plaintext into <code>n</code> pairs (with a length equal to the key, denoted as <code>l</code>), it forms an <code>n*l</code> matrix. XORing it with the key results in the ciphertext.</p><p>$$
\begin{bmatrix}
m_{00} & a_{01} & &mldr; & m_{0l} \\
m_{10} &&& &mldr;\\
&mldr; &&& &mldr;\\
m_{n0} &&mldr; &&mldr; & m_{nl}
\end{bmatrix}\oplus
\begin{bmatrix}
k_{0} &
k_{1} &
&mldr; &
k_{l}
\end{bmatrix}=
\begin{bmatrix}
c_{00} & c_{01} & &mldr; & c_{0l} \\
c_{10} &&& &mldr;\\
&mldr; &&& &mldr;\\
c_{n0} &&mldr; &&mldr; & c_{nl}
\end{bmatrix}
$$</p><p>For each column in the ciphertext, we XOR the bits with each other. If the result of the XOR operation is a letter, it indicates that the corresponding characters in the plaintext contain a space character. For the character that meets this condition the most times in a column, we can consider it as a space character. Therefore, while traversing the operations, we assign weights to different rows in each column. Each time a space appears in the XOR operation, we increase the weight of these two rows by 1. After the traversal, we set the character in the row with the highest weight as a space and use that value to restore the character in the other positions in that row. By repeating this process for each column, we can obtain the entire plaintext. Once we have the plaintext, it becomes easy to obtain the key (flag).</p><p>There is one final issue to address: how to determine the value of <code>n</code>. We can use a brute-force method to determine this by manually observing whether the decrypted plaintext appears as &ldquo;normal text.&rdquo;</p><p>We can write a simple script to find the greatest common divisor of the padded plaintext length to estimate possible key lengths. For this problem, the possible key lengths are 2, 19, 31, 38, and 62. Here is the decryption script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># c: ciphertext</span>
</span></span><span class=line><span class=cl><span class=c1># l: length of the key</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode</span><span class=p>(</span><span class=n>c</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>l</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>rows</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>0</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>l</span><span class=p>)]</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=o>//</span><span class=p>(</span><span class=n>l</span><span class=o>*</span><span class=mi>2</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=o>//</span><span class=p>(</span><span class=n>l</span><span class=o>*</span><span class=mi>2</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>c</span><span class=p>[</span><span class=mi>2</span><span class=o>*</span><span class=n>i</span><span class=o>*</span><span class=n>l</span><span class=p>:(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=o>*</span><span class=n>l</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># for every column of the matrix</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># weight of the space for every element</span>
</span></span><span class=line><span class=cl>        <span class=n>blanks</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=c1># for every row</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=c1># possibility of being &#39;0x20&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=c1># xor with other rows</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=n>j</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=c1># check the result of xor</span>
</span></span><span class=line><span class=cl>                <span class=n>ascii</span> <span class=o>=</span>  <span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>ascii</span> <span class=o>&lt;=</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;z&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>ascii</span> <span class=o>&lt;=</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;Z&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>p</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>blanks</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=c1># get the row of char that supposed to be 0x20 in this column</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>blanks</span><span class=o>.</span><span class=n>values</span><span class=p>(),</span> <span class=n>blanks</span><span class=o>.</span><span class=n>keys</span><span class=p>()))[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># restore plaintext on this column</span>
</span></span><span class=line><span class=cl>        <span class=n>plain</span><span class=p>[</span><span class=n>row</span><span class=p>][</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>plain</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=n>plain</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>row</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># print the result</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>plain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Call the function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=s2>&#34;201c...015d&#34;</span> <span class=c1># ciphertext omitted</span>
</span></span><span class=line><span class=cl><span class=n>decode</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=mi>31</span><span class=p>)</span>
</span></span></code></pre></div><p>The result obtained is:</p><pre tabindex=0><code>Once upon a time, in a kingdom 
called HEUCTF, there lived a wh
ite hat named Little White. Lit
tle White was very smart and lo
ved CTF. He often participated 
in CTF competitions and achieve
d many excellent results. One d
ay, the HEUCTF kingdom was inva
ded by hackers. The hackers des
troyed the kingdom&#39;s network sy
stem and stole the kingdom&#39;s we
alth. Little White decided to s
tand up and defeat the hackers 
to save the kingdom. Little Whi
te began his adventure. He firs
t found the clues left by the h
ackers, and then tracked down t
he hackers&#39; hideout according t
o the clues. In the hackers&#39; hi
deout, Little White had a fierc
e battle with the hackers. Afte
r a hard battle, Little White f
inally defeated the hackers and
 saved the kingdom. The people 
of the kingdom were very gratef
ul to Little White and called h
im a hero. Little White&#39;s story
 spread throughout the kingdom,
 inspiring everyone. Everyone h
opes that they can also become
a hero like Little White and fi
ght for justice. In the end of
the story, Little White became
the guardian of the HEUCTF king
dom. He continued to study hard
 and improve his skills in orde
r to better protect the kingdom
.
</code></pre><p>A very reasonable plaintext indeed. From this, we can XOR any row with the corresponding row in the ciphertext to obtain the flag <code>orgctf{p1ease_j0in_the_HEUCTF!}</code>.</p><h3 id=25-using-hamming-distance-to-estimate-key-length>2.5 Using Hamming Distance to Estimate Key Length</h3><p>As the length of the plaintext increases, brute-forcing the key length becomes highly inefficient. We can calculate the Hamming distance to estimate the key length. The Hamming distance between two ASCII-encoded English characters is usually between 2 and 3, meaning the average Hamming distance for normal English letters is 2-3. For any characters (non-pure letters), the average Hamming distance between them is 4.</p><p>In this problem, since the ciphertext is obtained by XORing the plaintext with a key, under the assumption that the key length is correct, the Hamming distance between different ciphertext groups should be in the range of 2-3. We can write a script to calculate the Hamming distance between ciphertext groups for each possible key length.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_avg_hamming_weight</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>avgs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=c1># l stands for the number of characters in ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>l</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=c1># i stands for the length of the key</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Make sure i is a divisor of l</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>l</span> <span class=o>%</span> <span class=n>i</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>l</span> <span class=o>//</span> <span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>rows</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span> <span class=o>+</span> <span class=n>c</span><span class=p>[</span><span class=n>j</span> <span class=o>*</span> <span class=n>i</span> <span class=p>:</span> <span class=n>j</span> <span class=o>*</span> <span class=n>i</span> <span class=o>+</span> <span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>avg</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=n>avg</span> <span class=o>+=</span> <span class=nb>bin</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>rows</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>int</span><span class=p>(</span><span class=n>rows</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=mi>16</span><span class=p>))</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avg</span> <span class=o>=</span> <span class=n>avg</span> <span class=o>/</span> <span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avgs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>avg</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>avgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>get_avg_hamming_weight</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>
</span></span></code></pre></div><p>The output is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mi>1</span><span class=p>:</span> <span class=mf>3.568754841306132</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>2</span><span class=p>:</span> <span class=mf>3.3118626058233143</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>19</span><span class=p>:</span> <span class=mf>3.5943666675944224</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>31</span><span class=p>:</span> <span class=mf>3.2528793649336945</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>38</span><span class=p>:</span> <span class=mf>3.358234295415959</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>62</span><span class=p>:</span> <span class=mf>2.6361063950198074</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>589</span><span class=p>:</span> <span class=mf>3.7928692699490663</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In this problem, the lengths of the plaintext and the key are not large, so the Hamming distance may not be highly indicative. However, when the plaintext and ciphertext lengths are significantly larger, Hamming distance can be a valuable method for estimating the key length.</p><h2 id=3-conclusion>3 Conclusion</h2><p>A stream cipher must ensure one-time-only encryption to prevent leakage of information. Pseudo-random key stream generation algorithms must be unpredictable; otherwise, under sufficient redundancy, the security issue demonstrated in this problem may occur.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-11-03</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/cybersecurity/>cybersecurity</a>,&nbsp;<a href=/tags/ctf/>CTF</a>,&nbsp;<a href=/tags/crypto/>Crypto</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/everything-about-https/ class=prev rel=prev title="Everything about HTTPS"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Everything about HTTPS</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=www.debidong.github.io target=_blank>debidong</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>