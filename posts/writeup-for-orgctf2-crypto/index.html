<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>- debidong's site</title><meta name=Description content="debidong's site"><meta property="og:title" content><meta property="og:description" content="1 题目 小杨同学在上完密码学课程后，决定要自己设计一款又安全、计算开销又小的密码算法。 他叫嚣该算法坚不可摧，并公然把自己的源码和加密示例公之于"><meta property="og:type" content="article"><meta property="og:url" content="http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/"><meta property="og:image" content="http://www.debidong.github.io/logo.png"><meta property="article:section" content="posts"><meta property="og:site_name" content="debidong's site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.debidong.github.io/logo.png"><meta name=twitter:title content><meta name=twitter:description content="1 题目 小杨同学在上完密码学课程后，决定要自己设计一款又安全、计算开销又小的密码算法。 他叫嚣该算法坚不可摧，并公然把自己的源码和加密示例公之于"><meta name=application-name content="debidong's site"><meta name=apple-mobile-web-app-title content="debidong's site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/><link rel=next href=http://www.debidong.github.io/posts/image-format-in-computer/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.debidong.github.io\/posts\/writeup-for-orgctf2-crypto\/"},"genre":"posts","wordcount":2641,"url":"http:\/\/www.debidong.github.io\/posts\/writeup-for-orgctf2-crypto\/","license":"debidong","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"debidong"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="debidong's site">debidong's site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="debidong's site">debidong's site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX"></h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=www.debidong.github.io title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>debidong</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=0001-01-01>0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2641 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-题目>1 题目</a></li><li><a href=#2-题解>2 题解</a><ul><li><a href=#21-分析-encrypt-函数>2.1 分析 <code>encrypt</code> 函数</a></li><li><a href=#22-关于异或>2.2 关于异或</a></li><li><a href=#23-ascii码和异或>2.3 ASCII码和异或</a></li><li><a href=#24-最终解题思路>2.4 最终解题思路</a></li><li><a href=#25-利用汉明距离推测密钥长度>2.5 利用汉明距离推测密钥长度</a></li><li><a href=#3-总结>3 总结</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=1-题目>1 题目</h2><blockquote><p>小杨同学在上完密码学课程后，决定要自己设计一款又安全、计算开销又小的密码算法。
他叫嚣该算法坚不可摧，并公然把自己的源码和加密示例公之于众。
现在这里有一份该示例的副本，希望你能让他见识到大黑客的厉害。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>debidong</span> <span class=kn>import</span> <span class=n>story</span><span class=p>,</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>OO0000O00OO0OOOOO</span><span class=p>,</span><span class=n>O0O000OO00000O000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>OO0000O00OO0OOOOO</span> <span class=o>+=</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>O0O000OO00000O000</span><span class=p>)</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>OO0000O00OO0OOOOO</span><span class=p>)</span><span class=o>%</span><span class=nb>len</span><span class=p>(</span><span class=n>O0O000OO00000O000</span><span class=p>))</span><span class=o>*</span><span class=s2>&#34; &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>O0OO00OO0OO00O0OO</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>OOOO00O0O0OOOO00O</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>OO0000O00OO0OOOOO</span><span class=p>)</span><span class=o>//</span><span class=nb>len</span><span class=p>(</span><span class=n>O0O000OO00000O000</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>OO0OO000000OOO0O0</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>O0O000OO00000O000</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>O0OO00OO0OO00O0OO</span> <span class=o>+=</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>OO0000O00OO0OOOOO</span><span class=p>[</span><span class=n>OOOO00O0O0OOOO00O</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>O0O000OO00000O000</span><span class=p>)</span><span class=o>+</span><span class=n>OO0OO000000OOO0O0</span><span class=p>])</span><span class=o>^</span><span class=nb>ord</span><span class=p>(</span><span class=n>O0O000OO00000O000</span><span class=p>[</span><span class=n>OO0OO000000OOO0O0</span><span class=p>]))[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>O0OO00OO0OO00O0OO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>encrypt</span><span class=p>(</span><span class=n>story</span><span class=p>,</span><span class=n>flag</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 201c040654130b1f5f45005311360755454e361a48047f232c3b2430294c5d0c130b0f11025b387430222723734a44010b2d114809363e20316335665615060602431c070f505f040c16017f26591d1a33114832372131306d740a48091b1e0243230e120454451612167f1c551b177f0705042d3c65342d30664d121917034337323d5e112d04530a391e55074e2f151a11362b2c25222023455d061c472020205b135e08111611361e5906002c54090b3b6824362b3d2357180b520a021a1f5b154906041f093a0444491c3a071d092b3b6b750c3a2301190e0b4b43000e1e507920343031194a5b0000381007087f3f2426633d28571c0b170343161f5b1850060a16172c44103d063a5400043c232027307422440e1b00081a11025b04590041180c310d5406037807480b3a3c323a313f6652041c06020e540715141116151c093a4a44010b7f1f010b382c2a3864276656180e1e130b5a46371945110d16450802591d0b7f100d06362c2031632029010e1b13090754130b50500b0553013a0c55081a7f0000007f202436283134525d1b1d471015101e50450d04530e3604570d01325a4829363c313926741149141b17470111011a1e110d0800453e0e460c002b011a0071680d3063322f530e1b52010c01081f50450d045306331f551a4e33110e117f2a3c75373c2301150e110c0606155750500b055311370f5e491a2d150b0e3a2c65312c232801090717470b15051015431646530d360e55061b2b5409063c2737312a3a2101090052130b1146181c4400125d451604101d063a5400043c23202730736649140b170816004a5b3c5811151f007f3d58001a3a5400043b682475253d23531e0a52050200121715111208070d7f1e580c4e37150b0e3a3a367b63152055181d5206431c0709141107000711330f1c492236001c093a68123d2a2023011b061c060f181f5b1454030412113a0e101d063a5400043c2320273074274f194f01061511025b04590041180c310d54060371543c0d3a6835302c242a445d001447171c035b1b580b06170a324a470c1c3a541e002d316532313532441b1a1e47171b46371945110d16450802591d0b7f1506017f2b24392f31220115061f4702540e1e025e4b413f0c2b1e5c0c4e081c01113a6f367530202953044f01171111071f50450d131c1038025f1c1a7f0000007f232c3b2430294c514f1b0910040f09195f024116133a184906003a5a4820292d372c2c3a23011500020210541213114545151b00264a5308007f15041630682730203b2b445d0e520f0606095b1c580e045329361e44050b7f23000c2b2d65342d30664714081a1343120909505b1012070c3c0f1e492731541c0d3a68203b277429475d1b1a0243071214024849413f0c2b1e5c0c4e081c01113a68273020352b445d1b1a024313131a02550c001d45300c101d063a5420200a0b1113633f2f4f1a0b1d0a4d542e1e50520a0f070c311f550d4e2b1b48162b3d212c633c2753194f130907540f1600430a171645370343491d341d04092c682c3b633b3445181d52130c54041e0445001353152d05440c0d2b541c0d3a682e3c2d33224e104152474354465b5011454153457f4a10494e7f5448457f686575637466015d</span>
</span></span></code></pre></div><h2 id=2-题解>2 题解</h2><h3 id=21-分析-encrypt-函数>2.1 分析 <code>encrypt</code> 函数</h3><p>首先关注函数 <code>encrypt</code>，手工重命名变量名以反混淆，梳理得到原函数的大致代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>m</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>+=</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=o>*</span><span class=s2>&#34; &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>//</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>c</span> <span class=o>+=</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>m</span><span class=p>[</span><span class=n>i</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=o>+</span><span class=n>j</span><span class=p>])</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=n>j</span><span class=p>]))[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span>
</span></span></code></pre></div><p>可以看到，函数首先对明文进行了填充（padding）操作，向明文后追加了若干个空字符 <code></code>使得明文的长度能被密钥长度整除。</p><p>之后，将明文按密钥长度分成若干段，对每段的每个字符，都和密钥对应位置的字符进行异或。例如，对于明文 <code>0x453618</code> 和 密钥 <code>0x4376</code>：</p><ol><li>函数会首先将明文填充至密钥长度的整数倍，即在后面追加一个 <code>0x20</code>，明文变为 <code>0x45361820</code>。</li><li>函数将明文分为两组： <code>0x4536</code> 和 <code>0x1820</code>，然后分别求 <code>0x4536 ^ 0x4376</code> 和 <code>0x1820 ^ 0x4376</code>，得到 <code>0x0640</code> 和 <code>0x5b56</code>。</li><li>将两组异或后的密文合并，得到密文 <code>0x06405b56</code>。</li></ol><p>加密函数到这里分析完毕。不难联想到这是一个类似于流密码的加密方法，但是问题在于，流密码对于明文的任何字段都要做到<strong>一次一密</strong>，然而本题目的加密方法重复使用了单一密钥对于不同文本进行加密。这会带来严重的安全问题（下一节）。</p><h3 id=22-关于异或>2.2 关于异或</h3><p>首先，让我们回忆一下异或操作的真值表：</p><table><thead><tr><th></th><th>0</th><th>1</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>0</td></tr></tbody></table><p>当两个数不同时，异或将会返回真，否则为假。不难看出，<strong>一个数和自己本身异或运算的结果是0</strong>，并且<strong>异或运算满足交换律</strong>。所以对于异或运算存在这样的一个性质：</p><p><strong>两个数相互按位异或的结果 == 两个数先分别与一个相同的数进行异或，再相互异或的结果</strong></p><p>即：
$$
a \oplus b = (a \oplus c) \oplus (b \oplus c)
$$
证明也很简单，因为前两条性质成立：
$$
(a \oplus c) \oplus (b \oplus c) = (a \oplus b)\oplus(c\oplus c) = a \oplus b
$$
那么，如果将本题的密文拆分成和密钥长度相等长度的子字符串，便可以利用这条性质&mldr;但是明文之间的异或可以揭示什么信息？</p><h3 id=23-ascii码和异或>2.3 ASCII码和异或</h3><p>还记得什么是ASCII码吗？如今的ASCII码是UTF的子集，可以用8比特字符表示英文字符和其他的控制符号。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/1280px-USASCII_code_chart.png data-srcset="./assets/1280px-USASCII_code_chart.png, ./assets/1280px-USASCII_code_chart.png 1.5x, ./assets/1280px-USASCII_code_chart.png 2x" data-sizes=auto alt=./assets/1280px-USASCII_code_chart.png title=1280px-USASCII_code_chart></p><p>现在让我们关注<strong>空格</strong>的ASCII码 <code>0x20</code>。它用二进制表示是 <code>00100000</code>。让我们再关注字母 <code>A</code>，其对应的ASCII码是 <code>01000001</code>。将A和空格异或，会发生什么？</p><p>首先异或低四位。由于<strong>0异或任何数都是0</strong>，运算结果的低四位将会和A的低四位相同；再异或高四位，空格的第六位数是1，这样的话将会使结果与A的第六位相反，但其他位均保持不变。最终的运算结果为 <code>01100001</code>，是 <code>a</code>。</p><p>注意到，每个大小字母和其对应的小写字母均在ASCII表相同的行上，只是列不同，有2列的偏移。不难发现这样的结论：<strong>对于A-Z，其和 <code>0x20</code> （空格）异或均会得到对应的小写字母，反之亦然。</strong></p><p>由这个性质，我们可以知道：让密文两两异或，如异或结果出现了字母，则明文之中的对应位置应该为一个A-Z或a-z范围内的字符。（不要忘了密文的异或等于明文的异或。）</p><h3 id=24-最终解题思路>2.4 最终解题思路</h3><p>将明文拆成 <code>n</code> 对之后（长度和密钥相同，设为 <code>l</code>），使其组成一个 <code>n*l</code> 的矩阵。其与密钥异或后得到密文。
$$
\begin{bmatrix}
m_{00} & a_{01} & &mldr; & m_{0l} \
m_{10} &&& &mldr;\
&mldr; &&& &mldr;\
m_{n0} &&mldr; &&mldr; & m_{nl}
\end{bmatrix}\oplus
\begin{bmatrix}
k_{0} &
k_{1} &
&mldr; &
k_{l}
\end{bmatrix}=
\begin{bmatrix}
c_{00} & c_{01} & &mldr; & c_{0l} \
c_{10} &&& &mldr;\
&mldr; &&& &mldr;\
c_{n0} &&mldr; &&mldr; & c_{nl}
\end{bmatrix}
$$
对于密文的每一列，都让各个位互相异或；如果异或运算的结果是字母，则证明两个字符对应的明文之中含有空格。对于满足这样条件最多次数的字符，我们便可以认为它的明文是空格。因此，我们在遍历运算时可以为每一列中的不同行设定权重，每次异或运算出现空格就将这两行的权重加1，遍历结束后将权重最大的行的该字符的明文设定为空格，并根据该值还原出该行其他位置的字符明文。如此逐一还原每一列，便可以求出整个明文。求得明文后，密钥（flag）也就好求了。</p><p>目前还有最后的一个问题：如何确定 <code>n</code> 的大小？这里可以用爆破的方式来求，通过人工观测解密的明文是否是“正常的文本”。</p><p>我们可以写一个简单的脚本来求填充后的明文长度的最大公因数，来判断密钥的长度的可能，在此略去不表。对于这个题目，求出密钥的长度可能是2、19、31、38、62。接下来是解密的脚本。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=c1># c: ciphertext</span>
</span></span><span class=line><span class=cl><span class=c1># l: len of the key</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode</span><span class=p>(</span><span class=n>c</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>l</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>rows</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>0</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>l</span><span class=p>)]</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=o>//</span><span class=p>(</span><span class=n>l</span><span class=o>*</span><span class=mi>2</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=o>//</span><span class=p>(</span><span class=n>l</span><span class=o>*</span><span class=mi>2</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>c</span><span class=p>[</span><span class=mi>2</span><span class=o>*</span><span class=n>i</span><span class=o>*</span><span class=n>l</span><span class=p>:(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=o>*</span><span class=n>l</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># for every column of the matrix</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># weight of the blank for every element</span>
</span></span><span class=line><span class=cl>        <span class=n>blanks</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=c1># for every row</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=c1># possibility of being &#39;0x20&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=c1># xor with other rows</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=n>j</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=c1># check the result of xor</span>
</span></span><span class=line><span class=cl>                <span class=n>ascii</span> <span class=o>=</span>  <span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>ascii</span> <span class=o>&lt;=</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;z&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>ascii</span> <span class=o>&lt;=</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;Z&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>p</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>blanks</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=c1># get the row of char that supposed to be 0x20 in this column</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>blanks</span><span class=o>.</span><span class=n>values</span><span class=p>(),</span> <span class=n>blanks</span><span class=o>.</span><span class=n>keys</span><span class=p>()))[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># restore plaintext on this column</span>
</span></span><span class=line><span class=cl>        <span class=n>plain</span><span class=p>[</span><span class=n>row</span><span class=p>][</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>plain</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=n>plain</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>int</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=o>+</span><span class=n>rows</span><span class=p>[</span><span class=n>row</span><span class=p>][</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=p>:</span><span class=n>col</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># print the result</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>plain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>调用函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=s2>&#34;201c...015d&#34;</span> <span class=c1># ciphertext omitted</span>
</span></span><span class=line><span class=cl><span class=n>decode</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=mi>31</span><span class=p>)</span>
</span></span></code></pre></div><p>得到的结果是：</p><pre tabindex=0><code>Once upon a time, in a kingdom 
called HEUCTF, there lived a wh
ite hat named Little White. Lit
tle White was very smart and lo
ved CTF. He often participated 
in CTF competitions and achieve
d many excellent results. One d
ay, the HEUCTF kingdom was inva
ded by hackers. The hackers des
troyed the kingdom&#39;s network sy
stem and stole the kingdom&#39;s we
alth. Little White decided to s
tand up and defeat the hackers 
to save the kingdom. Little Whi
te began his adventure. He firs
t found the clues left by the h
ackers, and then tracked down t
he hackers&#39; hideout according t
o the clues. In the hackers&#39; hi
deout, Little White had a fierc
e battle with the hackers. Afte
r a hard battle, Little White f
inally defeated the hackers and
 saved the kingdom. The people 
of the kingdom were very gratef
ul to Little White and called h
im a hero. Little White&#39;s story
 spread throughout the kingdom,
 inspiring everyone. Everyone h
opes that they can also become
a hero like Little White and fi
ght for justice. In the end of
the story, Little White became
the guardian of the HEUCTF king
dom. He continued to study hard
 and improve his skills in orde
r to better protect the kingdom
.
</code></pre><p>很合理的明文。由此，可以使用任意一行和密文对应的行进行异或，得到flag值 <code>orgctf{p1ease_j0in_the_HEUCTF!}</code>。</p><h3 id=25-利用汉明距离推测密钥长度>2.5 利用汉明距离推测密钥长度</h3><p>随着明文长度的增加，暴力破解的密钥长度方法的效率十分低下。我们可以计算汉明距离来推测密钥长度。两个以ascii编码的英文字符的汉明距离是2-3之间，也就是说正常英文字母的平均汉明距离为2-3；任意字符（非纯字母）的两两汉明距离平均为4。</p><p>由于在本题中密文的异或等于明文的异或，在密钥长度猜想正确的情况下，不同密文分组之间的汉明距离应该在2-3的范围内。我们可以写出脚本来测算每个密钥长度猜想下的密文分组间的汉明距离。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_avg_hamming_weight</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>avgs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=c1># l stands for the number of chars in ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>l</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=o>//</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=c1># i stands for the length of key</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># make sure i = gcd(l)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>l</span> <span class=o>%</span> <span class=n>i</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>l</span><span class=o>//</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>rows</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span> <span class=o>+</span> <span class=n>c</span><span class=p>[</span><span class=n>j</span><span class=o>*</span><span class=n>i</span><span class=p>:</span><span class=n>j</span><span class=o>*</span><span class=n>i</span><span class=o>+</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>avg</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=n>avg</span> <span class=o>+=</span> <span class=nb>bin</span><span class=p>((</span><span class=nb>int</span><span class=p>(</span><span class=n>rows</span><span class=p>[</span><span class=n>j</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=nb>int</span><span class=p>(</span><span class=n>rows</span><span class=p>[</span><span class=n>k</span><span class=p>],</span><span class=mi>16</span><span class=p>)))</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avg</span> <span class=o>=</span> <span class=n>avg</span> <span class=o>/</span> <span class=p>(</span><span class=n>i</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avgs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>avg</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>avgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>get_avg_hamming_weight</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>
</span></span></code></pre></div><p>输出：</p><pre tabindex=0><code>{1: 3.568754841306132, 2: 3.3118626058233143, 19: 3.5943666675944224, 31: 3.2528793649336945, 38: 3.358234295415959, 62: 2.6361063950198074, 589: 3.7928692699490663}
</code></pre><p>由于本题的明文长度和密钥长度不大，汉明距离的参考价值也不大。但当明文长度和密文长度足够大时，汉明距离可以是推测密钥长度的一种方法。</p><h3 id=3-总结>3 总结</h3><p>流密码一定要做到一次一密，否则有可能会泄密。生成密钥的伪随机密钥流算法必须是不可预测的，否则在足够的冗余下会出现本题目的安全问题。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 0001-01-01</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/ data-title><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/ data-title><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/ data-title><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/ data-title><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/image-format-in-computer/ class=next rel=next title="Image Format in Computer">Image Format in Computer<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=www.debidong.github.io target=_blank>debidong</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>